# Tax Optimization Module (Phase 5.2)

## Overview
–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –º–æ–¥—É–ª—å –Ω–∞–ª–æ–≥–æ–≤–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º –ø–æ—Ä—Ç—Ñ–µ–ª—è, –≤—ã—è–≤–ª–µ–Ω–∏–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–ª–æ–≥–æ–≤, —É—á—ë—Ç–æ–º –°–û–ò–î–ù (Double Tax Avoidance Agreement), –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º –ò–ò–° –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ 3-–ù–î–§–õ.

**–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- Tax Loss Harvesting —Å wash sale detection (30-–¥–Ω–µ–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ)
- –†–∞—Å—á—ë—Ç –Ω–∞–ª–æ–≥–æ–≤ –Ω–∞ –¥–∏–≤–∏–¥–µ–Ω–¥—ã —Å —É—á—ë—Ç–æ–º –°–û–ò–î–ù
- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—ã—á–µ—Ç–æ–≤ –ò–ò–° (–¢–∏–ø –ê –∏ –¢–∏–ø –ë)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 3-–ù–î–§–õ
- –≠–∫—Å–ø–æ—Ä—Ç –≤ XML, PDF, Excel

## Features

### 1. Tax Calculator (–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞–ª–æ–≥–æ–≤)
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º —Ç–∏–ø–∞–º –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞.

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –†–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–∞ –Ω–∞ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—É—é –ø—Ä–∏–±—ã–ª—å (< 3 –ª–µ—Ç, 13%)
- –†–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–∞ –Ω–∞ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø—Ä–∏–±—ã–ª—å (‚â• 3 –ª–µ—Ç, 0% —Å –≤—ã—á–µ—Ç–æ–º)
- –†–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–∞ –Ω–∞ –¥–∏–≤–∏–¥–µ–Ω–¥—ã (13%)
- –†–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–∞ –Ω–∞ –∫—É–ø–æ–Ω—ã –æ–±–ª–∏–≥–∞—Ü–∏–π (13%)
- –£—á–µ—Ç –≤—ã—á–µ—Ç–æ–≤ –∏ —É–±—ã—Ç–∫–æ–≤
- –†–∞—Å—á–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –Ω–∞–ª–æ–≥–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–±–∏–≤–∫–∏ –ø–æ —Ç–∏–ø–∞–º –¥–æ—Ö–æ–¥–∞

### 2. Tax Loss Harvesting (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–±—ã—Ç–∫–æ–≤)
–ê–Ω–∞–ª–∏–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –Ω–∞–ª–æ–≥–æ–≤–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —É–±—ã—Ç–∫–æ–≤.

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–∏—Å–∫ –ø–æ–∑–∏—Ü–∏–π —Å –Ω–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ —É–±—ã—Ç–∫–∞–º–∏
- –†–∞—Å—á–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞–ª–æ–≥–æ–≤ (13% –æ—Ç —Å—É–º–º—ã —É–±—ã—Ç–∫–∞)
- –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –ø–æ —Ä–∞–∑–º–µ—Ä—É —ç–∫–æ–Ω–æ–º–∏–∏
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: "–ü—Ä–æ–¥–∞—Ç—å —Å–µ–π—á–∞—Å", "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å", "–î–µ—Ä–∂–∞—Ç—å"
- –û–±—â–∞—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è –ø–æ –ø–æ—Ä—Ç—Ñ–µ–ª—é

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:**
- **–ü—Ä–æ–¥–∞—Ç—å —Å–µ–π—á–∞—Å:** –£–±—ã—Ç–æ–∫ > 0 –∏ —ç–∫–æ–Ω–æ–º–∏—è > 1000 ‚ÇΩ
- **–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å:** –£–±—ã—Ç–æ–∫ > 0 –∏ —ç–∫–æ–Ω–æ–º–∏—è > 500 ‚ÇΩ
- **–î–µ—Ä–∂–∞—Ç—å:** –£–±—ã—Ç–æ–∫ —Å–ª–∏—à–∫–æ–º –º–∞–ª –∏–ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–∏–±—ã–ª–∏

### 3. Holding Period Tracker (–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –≤–ª–∞–¥–µ–Ω–∏—è)
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∑–∏—Ü–∏–π, –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –∫ 3-–ª–µ—Ç–Ω–µ–º—É –ø–æ—Ä–æ–≥—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–ª–æ–≥–æ–≤–æ–π –ª—å–≥–æ—Ç—ã.

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 90 –¥–Ω–µ–π –æ—Ç 3-–ª–µ—Ç–Ω–µ–≥–æ –ø–æ—Ä–æ–≥–∞
- –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤–ª–∞–¥–µ–Ω–∏—è
- Countdown —Ç–∞–π–º–µ—Ä –¥–æ –±–µ–∑–Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
- –†–∞—Å—á–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞
- –°–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π, –¥–æ—Å—Ç–∏–≥—à–∏—Ö –±–µ–∑–Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (‚â• 3 –ª–µ—Ç)
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–¥–µ—Ä–∂–∞–Ω–∏—é –ø–æ–∑–∏—Ü–∏–π

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏:**
- üü¢ ‚â§ 30 –¥–Ω–µ–π: –ë–ª–∏–∑–∫–æ –∫ –±–µ–∑–Ω–∞–ª–æ–≥–æ–≤–æ–º—É —Å—Ç–∞—Ç—É—Å—É
- üü° 31-60 –¥–Ω–µ–π: –°–∫–æ—Ä–æ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç –ø–æ—Ä–æ–≥–∞
- üîµ 61-90 –¥–Ω–µ–π: –ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫ –ø–æ—Ä–æ–≥—É

### 4. Tax Report (–ù–∞–ª–æ–≥–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã)
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —ç–∫—Å–ø–æ—Ä—Ç –Ω–∞–ª–æ–≥–æ–≤—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –ø–æ–¥–∞—á–∏ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏.

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ì–æ–¥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ –Ω–∞–ª–æ–≥–æ–≤
- –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º –¥–æ—Ö–æ–¥–∞
- –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –Ω–∞–ª–æ–≥–æ–æ–±–ª–∞–≥–∞–µ–º—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Excel
- –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥–æ–¥–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ª–µ—Ç)

## Architecture

### Components

```
src/components/features/Tax/
‚îú‚îÄ‚îÄ TaxCalculator.tsx           # –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞–ª–æ–≥–æ–≤
‚îú‚îÄ‚îÄ TaxLossHarvesting.tsx       # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–±—ã—Ç–∫–æ–≤
‚îú‚îÄ‚îÄ HoldingPeriodTracker.tsx    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –≤–ª–∞–¥–µ–Ω–∏—è
‚îî‚îÄ‚îÄ TaxReport.tsx               # –ù–∞–ª–æ–≥–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã
```

### Types

```typescript
// src/types/tax.ts

interface TaxableIncome {
  id: string;
  type: 'short-term-gain' | 'long-term-gain' | 'dividend' | 'coupon';
  amount: number;
  taxRate: number;
  taxAmount: number;
  year: number;
  date: Date;
  instrumentName: string;
  ticker?: string;
}

interface PositionTaxInfo {
  positionId: string;
  ticker: string;
  instrumentName: string;
  quantity: number;
  purchaseDate: Date;
  purchasePrice: number;
  currentPrice: number;
  unrealizedGain: number;
  unrealizedLoss: number;
  holdingDays: number;
  daysUntilLongTerm: number;
  isLongTerm: boolean;
  potentialTaxSavings: number;
}

interface TaxCalculation {
  totalIncome: number;
  shortTermGains: number;
  longTermGains: number;
  dividends: number;
  coupons: number;
  totalTax: number;
  shortTermTax: number;
  longTermTax: number;
  dividendTax: number;
  couponTax: number;
}
```

### Store

```typescript
// src/stores/taxStore.ts
import { create } from 'zustand';

interface TaxState {
  taxableIncomes: TaxableIncome[];
  selectedYear: number;
  isLoading: boolean;
  error: string | null;

  addTaxableIncome: (income: TaxableIncome) => void;
  removeTaxableIncome: (id: string) => void;
  setSelectedYear: (year: number) => void;
  loadTaxData: (year: number) => Promise<void>;
  generateReport: (year: number) => TaxReport;
  exportReport: (report: TaxReport, format: 'csv' | 'pdf') => void;
}

const useTaxStore = create<TaxState>(...);
```

### Utilities

```typescript
// src/lib/tax-utils.ts

// Tax rates
export const TAX_RATES = {
  SHORT_TERM: 0.13,      // 13% for < 3 years
  LONG_TERM: 0,          // 0% for >= 3 years
  DIVIDEND: 0.13,        // 13% on dividends
  COUPON: 0.13,          // 13% on coupons
};

// Core functions
export function calculateTax(input: TaxInput): TaxCalculation;
export function calculateHoldingDays(purchaseDate: Date): number;
export function isLongTermHolding(purchaseDate: Date): boolean;
export function daysUntilLongTerm(purchaseDate: Date): number;
export function calculateTaxSavings(unrealizedGain: number): number;
export function analyzeTaxLossHarvesting(position: PositionTaxInfo): TaxLossHarvestingOpportunity;
export function findHoldingPeriodAlerts(positions: PositionTaxInfo[], daysThreshold?: number): HoldingPeriodAlert[];
export function formatHoldingPeriod(days: number): string;
export function calculateEffectiveTaxRate(totalIncome: number, totalTax: number): number;
```

## Page Structure

```typescript
// src/app/tax/page.tsx
'use client';

export default function TaxPage() {
  const [activeTab, setActiveTab] = useState<'calculator' | 'harvesting' | 'holding' | 'report'>('calculator');
  const [positions, setPositions] = useState<PositionTaxInfo[]>([]);

  return (
    <div>
      {/* Tabs navigation */}
      {/* Tab content based on activeTab */}
    </div>
  );
}
```

## Usage Examples

### Using Tax Calculator

```typescript
import TaxCalculator from '@/components/features/Tax/TaxCalculator';

<TaxCalculator />
```

### Using Tax Loss Harvesting

```typescript
import TaxLossHarvesting from '@/components/features/Tax/TaxLossHarvesting';
import { PositionTaxInfo } from '@/types/tax';

const positions: PositionTaxInfo[] = [...]; // From portfolioStore

<TaxLossHarvesting positions={positions} />
```

### Using Holding Period Tracker

```typescript
import HoldingPeriodTracker from '@/components/features/Tax/HoldingPeriodTracker';

const positions: PositionTaxInfo[] = [...]; // From portfolioStore

<HoldingPeriodTracker positions={positions} />
```

### Using Tax Report

```typescript
import TaxReport from '@/components/features/Tax/TaxReport';

<TaxReport />
```

### Programmatic Tax Calculations

```typescript
import { calculateTax, calculateTaxSavings, formatHoldingPeriod } from '@/lib/tax-utils';

// Calculate tax liability
const taxCalc = calculateTax({
  shortTermGains: 100000,
  longTermGains: 50000,
  dividends: 20000,
  coupons: 10000,
  deductions: 5000,
});

console.log(taxCalc.totalTax); // Total tax amount

// Calculate potential savings
const savings = calculateTaxSavings(100000); // 13000 ‚ÇΩ

// Format holding period
const period = formatHoldingPeriod(800); // "2 –≥–æ–¥–∞ 2 –º–µ—Å—è—Ü–∞ 10 –¥–Ω–µ–π"
```

## Integration with Portfolio

### Current Implementation
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç mock –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.

### Planned Integration
```typescript
// TODO: Integrate with portfolioStore
import { usePortfolioStore } from '@/stores/portfolioStore';

const positions = usePortfolioStore((state) =>
  state.positions.map(p => ({
    positionId: p.id,
    ticker: p.ticker,
    instrumentName: p.name,
    quantity: p.quantity,
    purchaseDate: p.purchaseDate,
    purchasePrice: p.averagePrice,
    currentPrice: p.currentPrice,
    unrealizedGain: p.unrealizedPnL,
    // ... other fields
  }))
);
```

## Tax Rules (Russian Tax Code)

### Short-term Capital Gains (< 3 years)
- **Rate:** 13% (–ù–î–§–õ)
- **Calculation:** (Sale Price - Purchase Price) √ó Quantity √ó 13%
- **Payment:** Through broker withholding or annual tax return

### Long-term Capital Gains (‚â• 3 years)
- **Rate:** 0% (with deduction)
- **Deduction limit:** 3,000,000 ‚ÇΩ per year per taxpayer
- **Requirements:**
  - Securities purchased on Russian exchanges
  - Held for at least 3 years
  - Not sold within first 3 years

### Dividends
- **Rate:** 13% for Russian dividends
- **Withholding:** Automatic by broker or company
- **Foreign dividends:** Subject to double taxation treaties

### Bond Coupons
- **Rate:** 13% for most bonds
- **Exceptions:**
  - OFZ (–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏): 0%
  - Municipal bonds: 0%
  - Corporate bonds (issued after 2017): Taxable

### Tax Loss Harvesting
- Losses can offset gains within same calendar year
- Losses carry forward up to 10 years
- Must be declared in tax return (3-–ù–î–§–õ)

## Export Functionality

### CSV Export
```typescript
// Automatic download with BOM for Excel compatibility
// Includes:
// - Report metadata (year, generation date)
// - Summary (total income, total tax)
// - Breakdown by income type
// - Transaction details
```

### PDF Export (Planned)
```typescript
// Planned features:
// - Professional report layout
// - Charts and visualizations
// - Tax authority ready format
// - Digital signature support
```

## Configuration

### Tax Rates
```typescript
// src/lib/tax-utils.ts
export const TAX_RATES = {
  SHORT_TERM: 0.13,
  LONG_TERM: 0,
  DIVIDEND: 0.13,
  COUPON: 0.13,
};
```

### Holding Period Threshold
```typescript
export const LONG_TERM_HOLDING_DAYS = 365 * 3; // 3 years
```

### Alert Threshold
```typescript
// Default: 90 days before long-term threshold
findHoldingPeriodAlerts(positions, 90);
```

## Styling

### Color Scheme
- **Calculator:** Blue gradients (income/tax summary)
- **Loss Harvesting:** Green (savings), Red (losses)
- **Holding Period:**
  - Green: ‚â§30 days to threshold
  - Amber: 31-60 days
  - Blue: 61-90 days
- **Report:** Neutral grays with accent colors

### Responsive Design
- Mobile-first approach
- Grid layouts for summary cards
- Responsive tables with horizontal scroll
- Touch-friendly tab navigation

## Known Issues

1. **Mock Data:**
   - Currently uses hardcoded demo positions
   - Need integration with portfolioStore

2. **PDF Export:**
   - Not yet implemented
   - Shows alert to user

3. **Historical Data:**
   - No storage/persistence of tax transactions
   - Need API integration or local storage

4. **Multi-account:**
   - No support for multiple brokerage accounts
   - Need account selection UI

5. **Currency:**
   - Only RUB supported
   - Need currency conversion for foreign assets

## Future Enhancements

1. **Integration:**
   - Connect to portfolioStore for real positions
   - Sync with Tinkoff transaction history
   - Load realized gains/losses from broker

2. **Advanced Features:**
   - Tax loss harvesting suggestions with wash sale rules
   - Multi-year tax planning
   - Scenario modeling (what-if analysis)
   - Tax-efficient withdrawal strategies

3. **Export:**
   - PDF generation with charts
   - 3-–ù–î–§–õ XML export
   - Integration with tax software

4. **Notifications:**
   - Alerts for upcoming long-term thresholds
   - Year-end tax planning reminders
   - Dividend payment notifications

5. **Analytics:**
   - Historical tax burden charts
   - Tax efficiency metrics
   - Comparison with market benchmarks

## Testing

### Manual Testing Checklist
- [ ] Tax Calculator updates on input change
- [ ] All tax rates calculate correctly (13%, 0%)
- [ ] Effective tax rate displays accurately
- [ ] Loss harvesting shows correct opportunities
- [ ] Recommendations logic works (sell/consider/hold)
- [ ] Holding period progress bars accurate
- [ ] Long-term positions display correctly
- [ ] CSV export downloads with correct data
- [ ] Year selector changes report data
- [ ] All tooltips and info boxes display

### Edge Cases
- [ ] Zero income (all fields empty)
- [ ] Negative deductions
- [ ] Very large numbers (> 1M)
- [ ] Positions with exact 3-year holding
- [ ] No transactions for selected year

## Performance Considerations

- **Memoization:** Uses `useMemo` for expensive calculations
- **Lazy loading:** Components load only when tab is active
- **CSV generation:** Client-side, no server load
- **Position filtering:** Efficient array operations

## Accessibility

- Semantic HTML structure
- ARIA labels for interactive elements
- Keyboard navigation support
- Color contrast compliance (WCAG AA)
- Screen reader friendly tables

## Browser Compatibility

- **Supported:** Chrome, Firefox, Safari, Edge (latest 2 versions)
- **CSV download:** Works on all modern browsers
- **Date handling:** Uses native Date API

## License & Disclaimer

**Important:** This tool provides informational calculations only and does not constitute professional tax advice. Users should:
- Verify calculations with tax professionals
- Use official broker reports for tax filing
- Consult with licensed tax advisors
- Check current tax laws and regulations

## Related Documentation

- [PORTFOLIO_INTEGRATION.md](./PORTFOLIO_INTEGRATION.md) - Portfolio data source
- [ARCHITECTURE.md](../ARCHITECTURE.md) - Overall app architecture
- [API_PATTERNS.md](../API_PATTERNS.md) - API integration patterns

## Changelog

### v1.0.0 (2025-01-21)
- Initial implementation
- Tax Calculator component
- Tax Loss Harvesting component
- Holding Period Tracker component
- Tax Report component with CSV export
- Russian tax rules implementation
- Comprehensive documentation

### v2.0.0 (Phase 5.2 - 2025-11-22)
- **Wash Sale Detection:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏–ª–æ 30 –¥–Ω–µ–π
- **Dividend Tax Tracker:** –£—á—ë—Ç –°–û–ò–î–ù (US withholding + Russian tax)
- **IIS Calculator:** –†–∞—Å—á—ë—Ç –≤—ã—á–µ—Ç–æ–≤ –¥–ª—è –¢–∏–ø–∞ –ê –∏ –¢–∏–ø–∞ –ë
- **Advanced Loss Harvesting:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- **3-–ù–î–§–õ Export:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è XML –¥–ª—è –Ω–∞–ª–æ–≥–æ–≤–æ–π (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
- **API Routes:** –ù–æ–≤—ã–µ endpoints –¥–ª—è tax harvesting –∏ reporting
- **Store Integration:** –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Zustand taxStore
- **Extended Types:** –ù–æ–≤—ã–µ —Ç–∏–ø—ã –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞

---

# Phase 5.2 Additions (–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)

## 1. Wash Sale Detection (–ü—Ä–∞–≤–∏–ª–æ 30 –¥–Ω–µ–π)

### –û–ø–∏—Å–∞–Ω–∏–µ
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π wash sale ‚Äî –ø—Ä–æ–¥–∞–∂–∏ –∞–∫—Ç–∏–≤–∞ —Å —É–±—ã—Ç–∫–æ–º —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –ø–æ–∫—É–ø–∫–æ–π –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π.

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**lib/tax/tax-loss-harvesting.ts:**

```typescript
export function detectWashSale(
  figi: string,
  saleDate: Date,
  saleLoss: number,
  saleQuantity: number,
  recentPurchases: Array<{ date: Date; quantity: number }>
): WashSaleRule

export function wouldTriggerWashSale(
  figi: string,
  sellDate: Date,
  recentPurchases: Array<{ date: Date; quantity: number }>,
  futurePurchases?: Array<{ date: Date; quantity: number }>
): boolean
```

### –ü—Ä–∏–º–µ—Ä
```typescript
const washSaleRisk = wouldTriggerWashSale(
  'BBG000B9XRY4', // AAPL FIGI
  new Date(),     // –ü—Ä–æ–¥–∞–∂–∞ —Å–µ–≥–æ–¥–Ω—è
  [
    { date: new Date('2024-11-15'), quantity: 10 }, // –ü–æ–∫—É–ø–∫–∞ 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
  ]
);

console.log(washSaleRisk); // true ‚Äî —Ä–∏—Å–∫ wash sale!
```

## 2. Dividend Tax Tracker

### –û–ø–∏—Å–∞–Ω–∏–µ
–†–∞—Å—á—ë—Ç –Ω–∞–ª–æ–≥–æ–≤ –Ω–∞ –¥–∏–≤–∏–¥–µ–Ω–¥—ã —Å —É—á—ë—Ç–æ–º –°–û–ò–î–ù –º–µ–∂–¥—É –†–æ—Å—Å–∏–µ–π –∏ –°–®–ê/–¥—Ä—É–≥–∏–º–∏ —Å—Ç—Ä–∞–Ω–∞–º–∏.

### –§–æ—Ä–º—É–ª–∞ (–°–®–ê)
- –î–∏–≤–∏–¥–µ–Ω–¥—ã: $100
- –£–¥–µ—Ä–∂–∞–Ω–æ –≤ –°–®–ê (30%): $30
- –ù–î–§–õ –†–§ (13%): $13
- –ó–∞—á—ë—Ç –°–û–ò–î–ù: min($30, $13) = $13
- **–î–æ–ø–ª–∞—Ç–∞ –≤ –†–§:** $0

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç

**components/features/Tax/DividendTaxTracker.tsx:**

```tsx
import { DividendTaxTracker } from '@/components/features/Tax/DividendTaxTracker';

<DividendTaxTracker />
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –ò—Ç–æ–≥–∏ –ø–æ –¥–∏–≤–∏–¥–µ–Ω–¥–∞–º –∑–∞ –≥–æ–¥
- –†–∞–∑–±–∏–≤–∫—É –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
- –£–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ –Ω–∞–ª–æ–≥–∏
- –ó–∞—á—ë—Ç –ø–æ –°–û–ò–î–ù
- –ò—Ç–æ–≥–æ–≤—ã–π –Ω–∞–ª–æ–≥ –∫ —É–ø–ª–∞—Ç–µ

## 3. IIS Calculator

### –û–ø–∏—Å–∞–Ω–∏–µ
–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞ –ò–ò–° (–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –°—á—ë—Ç).

### –¢–∏–ø –ê - –í—ã—á–µ—Ç –Ω–∞ –≤–∑–Ω–æ—Å—ã
- –í—ã—á–µ—Ç: min(–≤–∑–Ω–æ—Å, 400,000‚ÇΩ) √ó 13%
- –ú–∞–∫—Å–∏–º—É–º: 52,000‚ÇΩ/–≥–æ–¥
- –ü–æ–¥—Ö–æ–¥–∏—Ç: –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤–∑–Ω–æ—Å—ã, —Å—Ä–µ–¥–Ω—è—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å

### –¢–∏–ø –ë - –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–∏–±—ã–ª—å
- –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ: 100% –ø—Ä–∏–±—ã–ª–∏
- –ü–æ–¥—Ö–æ–¥–∏—Ç: –í—ã—Å–æ–∫–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (> 13% –≥–æ–¥–æ–≤—ã—Ö)

### –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞

```typescript
import { recommendIISType } from '@/lib/tax/tax-loss-harvesting';

const rec = recommendIISType(
  yearlyContributions: 400000,
  estimatedProfit: 500000,
  yearsHeld: 3
);

console.log(rec.recommended);  // 'B'
console.log(rec.explanation);  // "–¢–∏–ø –ë –≤—ã–≥–æ–¥–Ω–µ–µ: —ç–∫–æ–Ω–æ–º–∏—è 65,000‚ÇΩ..."
```

## 4. Advanced Loss Harvesting

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- High priority: –£–±—ã—Ç–æ–∫ > 50,000‚ÇΩ
- Medium priority: Wash sale —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç (< 14 –¥–Ω–µ–π)
- Low priority: –ö–æ–Ω–µ—Ü –≥–æ–¥–∞ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è (< 60 –¥–Ω–µ–π)

**–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:**
- –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –ø–æ–∑–∏—Ü–∏–∏ (harvestable)
- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (wash sale)
- Potential tax savings (13% –æ—Ç —É–±—ã—Ç–∫–∞)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç

```tsx
import TaxLossHarvesting from '@/components/features/Tax/TaxLossHarvesting';

<TaxLossHarvesting />
```

## 5. Tax Reporting & 3-–ù–î–§–õ

### –û–ø–∏—Å–∞–Ω–∏–µ
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–ª–æ–≥–æ–≤–æ–π –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ —Å —ç–∫—Å–ø–æ—Ä—Ç–æ–º –≤ —Ñ–æ—Ä–º–∞—Ç—ã –¥–ª—è –§–ù–°.

### –§—É–Ω–∫—Ü–∏–∏
- –°–±–æ—Ä –≤—Å–µ—Ö –¥–æ—Ö–æ–¥–æ–≤ –∑–∞ –≥–æ–¥ (–∞–∫—Ü–∏–∏, –¥–∏–≤–∏–¥–µ–Ω–¥—ã, –∫—É–ø–æ–Ω—ã)
- –£—á—ë—Ç –≤—ã—á–µ—Ç–æ–≤ (–ò–ò–°, —É–±—ã—Ç–∫–∏)
- –†–∞—Å—á—ë—Ç –Ω–∞–ª–æ–≥–æ–≤–æ–π –±–∞–∑—ã
- –≠–∫—Å–ø–æ—Ä—Ç –≤ XML (3-–ù–î–§–õ), PDF, Excel

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç

```tsx
import { TaxReporting } from '@/components/features/Tax/TaxReporting';

<TaxReporting />
```

### API Routes (TODO)

```typescript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞
GET /api/tax/report?accountId={id}&year={year}
Response: TaxReportData

// –≠–∫—Å–ø–æ—Ä—Ç
POST /api/tax/export
Body: { year, format: '3ndfl' | 'pdf' | 'excel', report }
Response: File download
```

## –ù–æ–≤—ã–µ —Ç–∏–ø—ã (types/tax.ts)

### LossPosition
```typescript
interface LossPosition {
  figi: string;
  ticker: string;
  name: string;
  quantity: number;
  averageCost: number;
  currentPrice: number;
  totalCost: number;
  currentValue: number;
  unrealizedLoss: number;
  potentialTaxSavings: number; // 13% –æ—Ç —É–±—ã—Ç–∫–∞
  washSaleRisk: boolean;
  washSaleDate?: Date;
  recommendedAction: 'harvest' | 'wait' | 'avoid';
  reason: string;
}
```

### DividendTaxInfo
```typescript
interface DividendTaxInfo {
  id: string;
  figi: string;
  ticker: string;
  paymentDate: Date;
  amount: number;
  currency: string;
  countryOfOrigin: string;
  withholdingTax: number;
  withholdingRate: number;
  russianTax: number; // 13% –ù–î–§–õ
  dtaaCredit: number; // –∑–∞—á—ë—Ç –°–û–ò–î–ù
  netTax: number;     // –∏—Ç–æ–≥–æ –∫ —É–ø–ª–∞—Ç–µ –≤ –†–§
  netAmount: number;
}
```

### IISDeduction
```typescript
interface IISDeduction {
  type: 'A' | 'B';
  year: number;
  contributions?: number;      // –¢–∏–ø –ê
  deduction?: number;          // –¢–∏–ø –ê: min(contributions, 400k) * 13%
  profitExemption?: number;    // –¢–∏–ø –ë: 100% –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
}
```

## –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —Å—Ç–∞–≤–æ–∫

```typescript
export const TAX_RATES = {
  PERSONAL_INCOME: 0.13,              // 13% –ù–î–§–õ
  US_DIVIDEND_WITHHOLDING: 0.30,      // 30% withholding –°–®–ê
  EFFECTIVE_US_DIVIDEND: 0.13,        // 13% –ø–æ—Å–ª–µ –°–û–ò–î–ù
  IIS_TYPE_A_MAX_DEDUCTION: 52000,    // max 52k/–≥–æ–¥
  IIS_TYPE_B_EXEMPTION: 1.0,          // 100% –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
} as const;
```

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **Wash Sale:** –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è. –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –æ–ø—Ü–∏–æ–Ω—ã –∏ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.
2. **–°–û–ò–î–ù:** –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –°–®–ê. –î–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 15%.
3. **–ò–ò–°:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –≤–∑–Ω–æ—Å–æ–≤.
4. **3-–ù–î–§–õ XML:** –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –§–ù–°.
5. **–ü–µ—Ä–µ–Ω–æ—Å —É–±—ã—Ç–∫–æ–≤:** –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —É—á—ë—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞ –±—É–¥—É—â–∏–µ –≥–æ–¥—ã.

## –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

- [ ] –ü–æ–ª–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è 3-–ù–î–§–õ XML
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API –±—Ä–æ–∫–µ—Ä–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è wash sale (–æ–ø—Ü–∏–æ–Ω—ã, —Ñ—å—é—á–µ—Ä—Å—ã)
- [ ] –ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
- [ ] –°–∏–º—É–ª—è—Ü–∏—è –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (What-If —Å—Ü–µ–Ω–∞—Ä–∏–∏)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –ò–ò–° –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å—á—ë—Ç–∞

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–í–ê–ñ–ù–û:**
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ò–ù–ù, –∞–¥—Ä–µ—Å) –ù–ï —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –í—Å–µ —Ä–∞—Å—á—ë—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è client-side
- API —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (TODO: –¥–æ–±–∞–≤–∏—Ç—å middleware)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ production

## –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É

–ú–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **—Å–ø—Ä–∞–≤–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é** –∏ –ù–ï —è–≤–ª—è–µ—Ç—Å—è –Ω–∞–ª–æ–≥–æ–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π. –ü–µ—Ä–µ–¥ –ø—Ä–∏–Ω—è—Ç–∏–µ–º —Ä–µ—à–µ–Ω–∏–π:

1. –ü—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –Ω–∞–ª–æ–≥–æ–≤—ã–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ª–æ–≥–æ–≤—ã—Ö —Å—Ç–∞–≤–æ–∫
3. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø–æ–¥–∞—á–µ–π –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–ù–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–¥–µ–∫—Å –†–§ (–≥–ª–∞–≤–∞ 23 - –ù–î–§–õ)](https://www.consultant.ru/document/cons_doc_LAW_28165/)
- [–°–û–ò–î–ù –†–§-–°–®–ê](https://www.consultant.ru/document/cons_doc_LAW_16755/)
- [–ò–ò–° - –¶–ë –†–§](https://cbr.ru/finmarket/inv_acc/)
- [3-–ù–î–§–õ —Ñ–æ—Ä–º–∞—Ç](https://www.nalog.gov.ru/rn77/taxation/taxes/ndfl/)
